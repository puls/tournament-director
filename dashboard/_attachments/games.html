<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <title>Tournament Director &rarr; Games</title>
  <link rel="stylesheet" href="style/dashboard.css" type="text/css" media="screen" charset="utf-8" />
  <link rel="stylesheet" href="style/jquery.autocomplete.css" type="text/css" media="screen" charset="utf-8" />
</head>

<body>
  <div id="container">
    <h1 id="tournament_name"></h1>
    <form id="team_form">
      <h2 id="teams">
        <div class="right">
          <label for="round">Round:</label>
          <input name="round" id="team_round" value="1" />
        </div>
        Enter Team Scores (<span id="team_status"></span>)
      </h2>
      <div>
        <input type="hidden" name="_id" value="" id="game_id" />
        <input type="hidden" name="_rev" value="" id="game_rev" />
        <input type="hidden" name="team1-name" value="" id="team1-name" />
        <input type="hidden" name="team2-name" value="" id="team2-name" />
        <table>
          <tr>
            <th>Round</th>
            <th>Team</th>
            <th>Card</th>
            <th>Points</th>
            <th>Tossups</th>
            <th>Room</th>
            <th></th>
          </tr>
          <tr>
            <td rowspan="2" id="round">1</td>
            <td>
              <select id="team1" name="team1-id" tabindex="1"></select>
            </td>
            <td><input type="text" name="team1-card" value="0" id="team1-card" size="3" tabindex="3" /></td>
            <td><input type="text" name="team1-points" value="" id="team1-points" size="3" tabindex="5" /></td>
            <td rowspan="2"><input type="text" name="tossups" value="" id="tossups" size="2" tabindex="7" /></td>
            <td rowspan="2"><input type="text" name="room" value="" id="room" tabindex="8" /></td>
            <td rowspan="2">
              <button id="save" tabindex="9">Save &rarr;</button>
              <span id="team_success" style="display: none;">Saved!</span>
            </td>
          </tr>
          <tr>
            <td>
              <select id="team2" name="team2-id" tabindex="2"></select>
            </td>
            <td><input type="text" name="team2-card" value="0" id="team2-card" size="3" tabindex="4" /></td>
            <td><input type="text" name="team2-points" value="" id="team2-points" size="3" tabindex="6" /></td>
          </tr>
        </table>
      </div>
    </form>
      <h2 id="individuals">
        <input type="search" id="search" value="" class="right" />
        Pending Individual Scores
      </h2>
      <div>
        <ul id="indivs_list"></ul>
        <form id="indivs_form" style="display: none;">
          <div class="right">
            <label for="tossups">Game Tossups: </label><input type="text" name="tossups" value="" id="indivs-tossups" size="3" />
            
          </div>
          <h3 id="indivs-team1-name">
            <label for="team1-points"></label>
            <input type="text" name="team1-points" value="" id="indivs-team1-points" size="3" />
          </h3>
          <table id="indivs-team1">
            <tr class="header">
              <th>Player</th>
              <th>Tossups</th>
              <th>15</th>
              <th>10</th>
              <th>-5</th>
              <th>Points</th>
            </tr>
            <tr class="entry">
              <td><input type="text" name="team1-player1-name" value="" class="player-name" /></td>
              <td><input type="text" size="3" name="team1-player1-tossups" value="" class="player-tossups" /></td>
              <td><input type="text" size="3" name="team1-player1-15" value="" class="player-15" /></td>
              <td><input type="text" size="3" name="team1-player1-10" value="" class="player-10" /></td>
              <td><input type="text" size="3" name="team1-player1-neg" value="" class="player-neg" /></td>
              <td class="player-points"></td>
            </tr>
            <tr class="totals">
              <td>Totals</td>
              <td class="total-tossups">0</td>
              <td class="total-15">0</td>
              <td class="total-10">0</td>
              <td class="total-neg">0</td>
              <td class="total-points">0</td>
            </tr>
          </table>

          <h3 id="indivs-team2-name">
            <label for="team2-points"></label>
            <input type="text" name="team2-points" value="" id="indivs-team2-points" size="3" />
          </h3>
          <table id="indivs-team2">
            <tr class="header">
              <th>Player</th>
              <th>Tossups</th>
              <th>15</th>
              <th>10</th>
              <th>-5</th>
              <th>Points</th>
            </tr>
            <tr class="entry">
              <td><input type="text" name="team2-player1-name" value="" class="player-name" /></td>
              <td><input type="text" size="3" name="team2-player1-tossups" value="" class="player-tossups" /></td>
              <td><input type="text" size="3" name="team2-player1-15" value="" class="player-15" /></td>
              <td><input type="text" size="3" name="team2-player1-10" value="" class="player-10" /></td>
              <td><input type="text" size="3" name="team2-player1-neg" value="" class="player-neg" /></td>
              <td class="player-points"></td>
            </tr>
            <tr class="totals">
              <td>Totals</td>
              <td class="total-tossups">0</td>
              <td class="total-15">0</td>
              <td class="total-10">0</td>
              <td class="total-neg">0</td>
              <td class="total-points">0</td>
            </tr>
          </table>

          <button id="cancel">Cancel</button>
          <button id="indivs-save">Save &rarr;</button>
          
          <!-- to swallow the focus -->
          <input type="text" size="1" class="right" />
        </form>
      </div>
    <p id="footer">
      <img src="tournamentdirector.png" width="314" height="42" alt="Tournament Director" />
    </p>
  </div>
  <div id="spinner">
    <div><img src="ajax-loader.gif" width="32" height="32" alt="Loading..." /></div>
  </div>
  <script src="/_utils/script/json2.js"></script>
  <script src="/_utils/script/jquery.js?1.3.1"></script>
  <script src="/_utils/script/jquery.couch.js?0.8.0"></script>
  <script src="/_utils/script/jquery.cookies.js"></script>
  <script src="vendor/couchapp/jquery.couchapp.js"></script>
  <script src="jquery.calculation.js"></script>
  <script src="jquery.autocomplete.js"></script>
  <script src="shared.js"></script>
  <script>
  /* <![CDATA[ */
  tournament = null;
  $.CouchApp(function (app) {
    var teams = {};
    var loadRound = function() {

      round = parseInt($('#team_round').val());
      $('#round').text(round);

      startTask();
      app.view('last_round_played', {
        group: true,
        success: function (response) {
          $('#team1').html('');
          $('#team2').html('');
          var teams_accounted_for = 0;
          $.each(response.rows, function (index, row) {
            if (row.value[0] < round) {
              var option = $('<option>');
              option.attr('value', row.key);
              option.text(teams[row.key].name);
              $('#team1').append(option.clone());
              $('#team2').append(option);
            } else {
              teams_accounted_for++;
            }
          });
          $('#team_status').text(teams_accounted_for + '/128');
          loadOpponents(round);
        }
      });

      startTask();
      app.view('pending_indivs', {
        success: function (response) {
          var list = $('#indivs_list');
          list.html('');
          if (response.rows.length > 0) {
            $.each(response.rows, function (key, row) {
              var game = row.value;
              var text = 'Round ' + game.round + ': ' + game.team1.name + ' ' + game.team1.points + ', ' + game.team2.name + ' ' + game.team2.points + ' in ' + game.room;
              var link = $('<a>').attr('href', '#').text(text).bind('click', game, function (event) {
                event.preventDefault();
                editIndivs(event.data);
                return false;
              });
              list.append($('<li>').append(link));
            });
            stopTask();
          }
        }
      });
    };
    
    var opponents = {};
    var loadOpponents = function (round) {
      app.view('next_opponent', {
        startkey: [round],
        endkey: [round, "ZZZZ"],
        success: function (response) {
          opponents = {};
          $.each(response.rows, function (index, row) {
            opponents[row.key[1]] = row.value;
          });
          updateBothTeams();
          stopTask();
        }
      });
      
    };
    
    loadSchools(function () {
      teams = {};
      $.each(schools, function (key, school) {
        $.each(school.teams, function (key, team) {
          teams[key] = team;
        });
      });
      loadRound();
    });
    $('#team_round').change(loadRound);
    
    var updateBothTeams = function (event) {
      var team = $('#team1').val();
      var line;
      if (opponents[team]) {
        line = opponents[team];
      } else {
        line = ['','','','','',''];
      }
      $('#team2').val(line[0]);
      $('#team1-card').val(line[1]);
      $('#team2-card').val(line[2]);
      $('#room').val(line[3]);
      $('#game_id').val(line[4]);
      $('#game_rev').val(line[5]);
      updateName();
    };
    
    $('#team1').change(updateBothTeams);

    var updateName = function (event) {
      $('#team1-name').val($('#team1').find(':selected').text());
      $('#team2-name').val($('#team2').find(':selected').text());
    };

    $('#team2').change(updateName);
    
    var updateCards = function () {
      var winnerCard = Math.min(parseInt($('#team1-card').val()), parseInt($('#team2-card').val()));
      var loserCard = Math.max(parseInt($('#team1-card').val()), parseInt($('#team2-card').val()));
      
      if (parseInt($('team1-points')) > parseInt($('team2-points'))) {
        var winner = [$('#team1').val(), $('#team1-name').val()];
        var loser = [$('#team2').val(), $('#team2-name').val()];
      } else {
        var winner = [$('#team2').val(), $('#team2-name').val()];
        var loser = [$('#team1').val(), $('#team1-name').val()];
      }
      
      startTask();
      app.view('next_game_for_card', {
        startkey: winnerCard,
        endkey: winnerCard,
        group: true,
        success: function (response) {
          if (response.rows[0]) {
            var game = response.rows[0].value[1];
            if (game.team1.card == winnerCard) {
              game.team1.id = winner[0];
              game.team1.name = winner[1];
            } else if (game.team2.card == winnerCard) {
              game.team2.id = winner[0];
              game.team2.name = winner[1];
            }
            app.db.saveDoc(game);
          }
          stopTask();
        }
      });
      
      startTask();
      app.view('next_game_for_card', {
        startkey: loserCard,
        endkey: loserCard,
        group: true,
        success: function (response) {
          if (response.rows[0]) {
            var game = response.rows[0].value[1];
            if (game.team1.card == loserCard) {
              game.team1.id = loser[0];
              game.team1.name = loser[1];
            } else if (game.team2.card == loserCard) {
              game.team2.id = loser[0];
              game.team2.name = loser[1];
            }
            app.db.saveDoc(game);
          }
          stopTask();
        }
      });
    };
    
    var teamsForm = app.docForm('#team_form', {
      fields: ['round', '_id', '_rev', 'team1-id', 'team1-card', 'team1-name', 'team1-points', 'team2-id', 'team2-card', 'team2-name', 'team2-points', 'room', 'tossups'],
      success: function (response) {
        $('#team_success').show().fadeOut(500);
        updateCards();
        loadRound();
      },
      beforeSave: function (doc) {
        doc.tossups = parseInt(doc.tossups);
        doc.round = parseInt(doc.round);
        doc.entry_complete = true;
        doc.type = 'game';
        doc.team1.card = parseInt(doc.team1.card);
        doc.team2.card = parseInt(doc.team2.card);
        doc.team1.points = parseInt(doc.team1.points);
        doc.team2.points = parseInt(doc.team2.points);
      }
    });

    var search = function (event) {
      var string = $('#search').val().toLowerCase();
      if (string === '') {
        $('#indivs_list li').show();
      } else {
        $('#indivs_list li').each(function (index) {
          var element = $(this);
          if (element.text().toLowerCase().indexOf(string) >= 0) {
            element.show();
          } else {
            element.hide();
          }
        });
      }
    };
    
    $('#search').keyup(search);
    $('#search').change(search);
    $('#search').blur(search);
    $('#search').click(search);

    var indivsForm = null;
    var autocompleteOptions = {};
    var playerNames = [];
    var editIndivs = function (game) {
      $('#indivs_list').slideUp();
      $('#indivs_form').slideDown();
      $('#search').fadeOut();
      
      indivsForm = app.docForm('#indivs_form', {
        id: game._id,
        fields: ['tossups', 'team1-points', 'team2-points'],
        success: editSuccess,
        onLoad: function (doc) {
          $('#indivs-team1-name').find('label').text(doc.team1.name);
          $('#indivs-team2-name').find('label').text(doc.team2.name);
          
          $('.player-name').unbind();
          
          autocompleteOptions = {
            autoFill: true,
            onItemSelect: function(li, input) {
              input.closest('tr').find('.player-tossups').focus();
            }
          }
          
          playerNames[0] = [];
          $.each(teams[doc.team1.id].players, function (key, player) {
            playerNames[0].push(player.name);
          });
          $('#indivs-team1 .player-name').autocompleteArray(playerNames[0], autocompleteOptions);

          playerNames[1] = [];
          $.each(teams[doc.team2.id].players, function (key, player) {
            playerNames[1].push(player.name);
          });
          $('#indivs-team2 .player-name').autocompleteArray(playerNames[1], autocompleteOptions);
          
          calcTotals();
          $('#indivs-team1 input:text:first').focus();
        },
        beforeSave: function (doc) {
          doc.tossups = parseInt(doc.tossups);
          doc.team1.points = parseInt(doc.team1.points);
          doc.team2.points = parseInt(doc.team2.points);
          doc.indivs_complete = true;

          doc.team1.players = {};
          doc.team2.players = {};

          var player_id = function (team_id, player_name) {
            var result = randomID(32);
            $.each(teams[team_id].players, function (key, player) {
              if (player.name === player_name) {
                result = key;
                return false;
              }
            });
            return result;
          };

          $('#indivs-team1 tr.entry').each(function (index) {
            var row = $(this);
            var name = row.find('.player-name').val();
            var key = player_id(doc.team1.id, name);
            doc.team1.players[key] = {
              name: name,
              id: key,
              tossups: parseInt(row.find('.player-tossups').val()),
              fifteens: parseInt(row.find('.player-15').val()),
              tens: parseInt(row.find('.player-10').val()),
              negs: parseInt(row.find('.player-neg').val()),
            }
          });

          $('#indivs-team2 tr.entry').each(function (index) {
            var row = $(this);
            var name = row.find('.player-name').val();
            var key = player_id(doc.team2.id, name);
            doc.team2.players[key] = {
              name: name,
              id: key,
              tossups: parseInt(row.find('.player-tossups').val()),
              fifteens: parseInt(row.find('.player-15').val()),
              tens: parseInt(row.find('.player-10').val()),
              negs: parseInt(row.find('.player-neg').val()),
            }
          });
        }
      });
    };
    
    var calcTotals = function () {
      $('#indivs-team1, #indivs-team2').each(function (teamIndex) {
        var table = $(this);
        table.find('tr.entry').each(function (index) {
          var row = $(this);
          var points = 15 * parseInt(row.find('.player-15').val() || 0) +
            10 * parseInt(row.find('.player-10').val() || 0) -
             5 * parseInt(row.find('.player-neg').val() || 0);
          row.find('.player-points').text(isNaN(points) ? '0' : points);
        });
        var totalTossups = table.find('.player-tossups').sum();
        var totalTossupsField = table.find('.total-tossups');
        totalTossupsField.text(totalTossups);
        if (totalTossups != 4 * parseInt($('#indivs-tossups').val())) {
          totalTossupsField.addClass('error');
        } else {
          totalTossupsField.removeClass('error');
        }
        table.find('.total-15').text(table.find('.player-15').sum());
        table.find('.total-10').text(table.find('.player-10').sum());
        table.find('.total-neg').text(table.find('.player-neg').sum());
        var totalPoints = table.find('.player-points').sum();
        var bonusPoints = parseInt($('#indivs-team' + (teamIndex + 1) + '-points').val()) - totalPoints || 0;
        var totalPointsField = table.find('.total-points');
        totalPointsField.text(totalPoints + ' / ' + bonusPoints);
        if (bonusPoints < 0) {
          totalPointsField.addClass('error');
        } else {
          totalPointsField.removeClass('error');
        }
      });
    };
    
    $('.player-tossups, .player-15, .player-10, #indivs-team1-points, #indivs-team2-points, #indivs-tossups').change(calcTotals);

    $('.player-tossups').blur(function (event) {
      if ($(this).val() === '') {
        $(this).val($('#indivs-tossups').val());
        calcTotals();
      }
    });

    $('.player-15').keyup(function (event) {
      if ($(this).val() === '000') {
        var row = $(this).parents('tr:first');
        row.find('.player-15').val('0');
        row.find('.player-10').val('0');
        row.find('.player-neg').val('0');
        calcTotals();
        row.find('.player-neg').focus();
      }
    });

    $('.player-neg').blur(function (event) {
      var row = $(this).parents('tr:first');
      
      if (!row.next().hasClass('totals')) {
        calcTotals();
        return true;
      }
      
      var advance = true;
      var allBlank = true;
      row.find('input:text:not(.player-tossups)').each(function (index) {
        if ($(this).val() === '') {
          advance = false;
        } else {
          allBlank = false;
        }
      });
      var nextFocus = null;
      var teamIndex = (row.parents('table:first').attr('id') === 'indivs-team1' ? 0 : 1);
      if (advance) {
        var newRow = row.clone(true);
        newRow.find('input').val('');
        newRow.find('.player-name').unbind().autocompleteArray(playerNames[teamIndex], autocompleteOptions);
        
        row.after(newRow);
        nextFocus = newRow.find('.player-name');
      } else if (allBlank && !row.prev().hasClass('header')) {
        if (teamIndex === 0) {
          nextFocus = $('#indivs-team2 input:text:first');
        } else {
          nextFocus = $('#indivs-team1 input:text:first');
        }
        row.remove();
      } else {
        nextFocus = row.find('.player-name');
      }
      calcTotals();
      var element = nextFocus.get(0);
      window.setTimeout(function () {
        element.focus();
      }, 1);
    });
    
    var editSuccess = function () {
      $('#indivs_form').unbind('submit');
      
      $('#search').fadeIn();
      $('#indivs_list').slideDown();
      $('#indivs_form').slideUp();
      
      $('#indivs_form table').each(function (index) {
        $(this).find('tr.entry:not(:first)').remove();
      });
      $('#indivs_form input').val('');
      
      loadRound();
    };
    
    $('#cancel').click(function (event) {
      event.preventDefault();
      editSuccess();
      return false;
    });

  });
  /* ]]> */
  </script>
</body>
</html>
